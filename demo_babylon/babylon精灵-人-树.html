<!DOCTYPE html>
<html>

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>Babylon.js sample code</title>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.6.2/dat.gui.min.js"></script>
		<script src="https://assets.babylonjs.com/generated/Assets.js"></script>
		<script src="https://preview.babylonjs.com/ammo.js"></script>
		<script src="https://preview.babylonjs.com/cannon.js"></script>
		<script src="https://preview.babylonjs.com/Oimo.js"></script>
		<script src="https://preview.babylonjs.com/earcut.min.js"></script>
		<script src="https://preview.babylonjs.com/babylon.js"></script>
		<script src="https://preview.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>
		<script src="https://preview.babylonjs.com/proceduralTexturesLibrary/babylonjs.proceduralTextures.min.js">
		</script>
		<script src="https://preview.babylonjs.com/postProcessesLibrary/babylonjs.postProcess.min.js"></script>
		<script src="https://preview.babylonjs.com/loaders/babylonjs.loaders.js"></script>
		<script src="https://preview.babylonjs.com/serializers/babylonjs.serializers.min.js"></script>
		<script src="https://preview.babylonjs.com/gui/babylon.gui.min.js"></script>
		<script src="https://preview.babylonjs.com/inspector/babylon.inspector.bundle.js"></script>
		<style>
			html,
			body {
				overflow: hidden;
				width: 100%;
				height: 100%;
				margin: 0;
				padding: 0;
			}

			#renderCanvas {
				width: 100%;
				height: 100%;
				touch-action: none;
			}
		</style>
	</head>

	<body>
		<div id='fps' style="position: absolute;background: #fff;left: 50%;top: 0;transform: translateX(-50%);pointer-events: none;"></div>
		<canvas id="renderCanvas"></canvas>
		<script>
			var canvas = document.getElementById('renderCanvas')
			var startRenderLoop = function(engine, canvas) {
				engine.runRenderLoop(function() {
					if (sceneToRender && sceneToRender.activeCamera) {
						sceneToRender.render()

						fps.innerHTML = engine.getFps().toFixed(2)
					}
				})
			}
			var engine = null
			var scene = null
			var sceneToRender = null
			var createDefaultEngine = function() {
				return new BABYLON.Engine(canvas, true, {
					preserveDrawingBuffer: true,
					stencil: true,
					disableWebGL2Support: false
				})
			}

			window.initFunction = async function() {

				var asyncEngineCreation = async function() {
					try {
						return createDefaultEngine()
					} catch (e) {
						console.log(
							'the available createEngine function failed. Creating the default engine instead'
						)
						return createDefaultEngine()
					}
				}

				window.engine = await asyncEngineCreation()
				if (!engine) throw 'engine should not be null.'
				startRenderLoop(engine, canvas)
				window.scene = createScene()
			}
			initFunction().then(() => {
				scene.then(returnedScene => {
					sceneToRender = returnedScene
				})
			})

			window.addEventListener('resize', function() {
				engine.resize()
			})

			const createScene = async function() {
				const scene = new BABYLON.Scene(engine)
				const camera = new BABYLON.ArcRotateCamera('camera', -Math.PI / 1.5, Math.PI / 2.2, 15, new BABYLON
					.Vector3(0, 0, 0))
				camera.upperBetaLimit = Math.PI / 2.2
				camera.attachControl(canvas, true)
				camera.setPosition(new BABYLON.Vector3(20, 20, 20))
				scene.registerBeforeRender(() => {})
				scene.debugLayer.show()

				const light = new BABYLON.HemisphericLight(
					'light',
					new BABYLON.Vector3(1, 1, 0)
				)



				// todo.....
				// 创建人
				const spriteManagerPlayer = new BABYLON.SpriteManager(
					'playerManager',
					'./babylon/textures/people.png',
					2,
					64,
					scene
				)
				const player = new BABYLON.Sprite('player', spriteManagerPlayer)
				player.playAnimation(0, 40, true, 100)
				// 想只显示一个特定的图像，只需要调用，不可以调用playAnimation
				// player.cellIndex = 10
				player.position.y = 1
				player.position.x = 1
				player.size = 1

				// 注册点击事件
				spriteManagerPlayer.isPickable = true
				player.isPickable = true
				player.actionManager = new BABYLON.ActionManager(scene)
				player.actionManager.registerAction(
					new BABYLON.ExecuteCodeAction(
						BABYLON.ActionManager.OnPickTrigger,
						function() {
							console.log(999)
							alert('player clicked')
						}
					)
				)

				

				// 将这个棕榈树图像用于树的精灵图，并为它设置了精灵管理器
				const spriteManagerTrees = new BABYLON.SpriteManager(
					'treesManager',
					'./babylon/textures/palm.png',
					2000, {
						width: 512,
						height: 1024
					},
					scene
				)
				// 在随机位置创建树
				for (let i = 0; i < 500; i++) {
					const tree = new BABYLON.Sprite('tree', spriteManagerTrees)
					tree.position.x = Math.random() * -30
					tree.position.z = Math.random() * 20 + 8
					tree.position.y = 0.5
				}
				for (let i = 0; i < 500; i++) {
					const tree = new BABYLON.Sprite('tree', spriteManagerTrees)
					tree.position.x = Math.random() * 25 + 7
					tree.position.z = Math.random() * -35 + 8
					tree.position.y = 0.5
				}
				// 天空盒
				const skybox = BABYLON.MeshBuilder.CreateBox(
					'skyBox', {
						size: 150
					},
					scene
				)
				const skyboxMaterial = new BABYLON.StandardMaterial('skyBox', scene)
				skyboxMaterial.backFaceCulling = false
				skyboxMaterial.reflectionTexture = new BABYLON.CubeTexture(
					'./babylon/textures/skybox',
					scene
				)
				skyboxMaterial.reflectionTexture.coordinatesMode =
					BABYLON.Texture.SKYBOX_MODE
				skyboxMaterial.diffuseColor = new BABYLON.Color3(0, 0, 0)
				skyboxMaterial.specularColor = new BABYLON.Color3(0, 0, 0)
				skybox.material = skyboxMaterial
				BABYLON.SceneLoader.ImportMeshAsync(
					'',
					'./babylon/scenes/',
					'valleyvillage.glb'
				)





				return scene
			}
		</script>
	</body>

</html>