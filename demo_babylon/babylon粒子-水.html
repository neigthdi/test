<!DOCTYPE html>
<html>

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>Babylon.js sample code</title>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.6.2/dat.gui.min.js"></script>
		<script src="https://assets.babylonjs.com/generated/Assets.js"></script>
		<script src="https://preview.babylonjs.com/ammo.js"></script>
		<script src="https://preview.babylonjs.com/cannon.js"></script>
		<script src="https://preview.babylonjs.com/Oimo.js"></script>
		<script src="https://preview.babylonjs.com/earcut.min.js"></script>
		<script src="https://preview.babylonjs.com/babylon.js"></script>
		<script src="https://preview.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>
		<script src="https://preview.babylonjs.com/proceduralTexturesLibrary/babylonjs.proceduralTextures.min.js">
		</script>
		<script src="https://preview.babylonjs.com/postProcessesLibrary/babylonjs.postProcess.min.js"></script>
		<script src="https://preview.babylonjs.com/loaders/babylonjs.loaders.js"></script>
		<script src="https://preview.babylonjs.com/serializers/babylonjs.serializers.min.js"></script>
		<script src="https://preview.babylonjs.com/gui/babylon.gui.min.js"></script>
		<script src="https://preview.babylonjs.com/inspector/babylon.inspector.bundle.js"></script>
		<style>
			html,
			body {
				overflow: hidden;
				width: 100%;
				height: 100%;
				margin: 0;
				padding: 0;
			}

			#renderCanvas {
				width: 100%;
				height: 100%;
				touch-action: none;
			}
		</style>
	</head>

	<body>
		<div id='fps'
			style="position: absolute;background: #fff;left: 50%;top: 0;transform: translateX(-50%);pointer-events: none;">
		</div>
		<canvas id="renderCanvas"></canvas>
		<script>
			var canvas = document.getElementById('renderCanvas')
			var startRenderLoop = function(engine, canvas) {
				engine.runRenderLoop(function() {
					if (sceneToRender && sceneToRender.activeCamera) {
						sceneToRender.render()

						fps.innerHTML = engine.getFps().toFixed(2)
					}
				})
			}
			var engine = null
			var scene = null
			var sceneToRender = null
			var createDefaultEngine = function() {
				return new BABYLON.Engine(canvas, true, {
					preserveDrawingBuffer: true,
					stencil: true,
					disableWebGL2Support: false
				})
			}

			window.initFunction = async function() {

				var asyncEngineCreation = async function() {
					try {
						return createDefaultEngine()
					} catch (e) {
						console.log(
							'the available createEngine function failed. Creating the default engine instead'
						)
						return createDefaultEngine()
					}
				}

				window.engine = await asyncEngineCreation()
				if (!engine) throw 'engine should not be null.'
				startRenderLoop(engine, canvas)
				window.scene = createScene()
			}
			initFunction().then(() => {
				scene.then(returnedScene => {
					sceneToRender = returnedScene
				})
			})

			window.addEventListener('resize', function() {
				engine.resize()
			})

			const createScene = async function() {
				const scene = new BABYLON.Scene(engine)
				const camera = new BABYLON.ArcRotateCamera('camera', -Math.PI / 1.5, Math.PI / 2.2, 15, new BABYLON
					.Vector3(0, 0, 0))
				camera.upperBetaLimit = Math.PI / 2.2
				camera.attachControl(canvas, true)
				camera.setPosition(new BABYLON.Vector3(50, 50, 50))
				scene.registerBeforeRender(() => {})
				scene.debugLayer.show()
				const light = new BABYLON.HemisphericLight('light', new BABYLON.Vector3(1, 1, 0))





				// todo.....
				// 打开和关闭喷泉
				let switched = false
				const pointerDown = mesh => {
					if (mesh === fountain) {
						switched = !switched
						if (switched) {
							// 启动粒子系统
							particleSystem.start()
						} else {
							// 停止粒子系统
							particleSystem.stop()
						}
					}
				}

				scene.onPointerObservable.add(pointerInfo => {
					switch (pointerInfo.type) {
						case BABYLON.PointerEventTypes.POINTERDOWN:
							if (pointerInfo.pickInfo.hit) {
								pointerDown(pointerInfo.pickInfo.pickedMesh)
							}
							break
					}
				})

				// 创建粒子系统
				const particleSystem = new BABYLON.ParticleSystem('particles', 5000)

				// 每个粒子的纹理
				particleSystem.particleTexture = new BABYLON.Texture('./babylon/textures/flare.png')

				// 粒子从何而来
				// 从喷泉顶部喷出
				particleSystem.emitter = new BABYLON.Vector3(-4, 0.8, -6)
				// 一切从
				particleSystem.minEmitBox = new BABYLON.Vector3(-0.01, 0, -0.01)
				// 到...
				particleSystem.maxEmitBox = new BABYLON.Vector3(0.01, 0, 0.01)

				// 所有粒子的颜色
				particleSystem.color1 = new BABYLON.Color4(0.7, 0.8, 1.0, 1.0)
				particleSystem.color2 = new BABYLON.Color4(0.2, 0.5, 1.0, 1.0)

				// 每个粒子的大小（随机...
				particleSystem.minSize = 0.01
				particleSystem.maxSize = 0.05

				// 每个粒子的寿命（随机...
				particleSystem.minLifeTime = 0.3
				particleSystem.maxLifeTime = 1.5

				// 排放率
				particleSystem.emitRate = 1500

				// 混合模式 : BLENDMODE_ONEONE, or BLENDMODE_STANDARD
				particleSystem.blendMode = BABYLON.ParticleSystem.BLENDMODE_ONEONE

				// 设置所有粒子的重力
				particleSystem.gravity = new BABYLON.Vector3(0, -9.81, 0)

				// 每个粒子发射后的方向
				particleSystem.direction1 = new BABYLON.Vector3(-1, 8, 1)
				particleSystem.direction2 = new BABYLON.Vector3(1, 8, -1)

				// 力量和速度
				particleSystem.minEmitPower = 0.2
				particleSystem.maxEmitPower = 0.6
				particleSystem.updateSpeed = 0.01

				const fountainProfile = [
					new BABYLON.Vector3(0, 0, 0),
					new BABYLON.Vector3(0.5, 0, 0),
					new BABYLON.Vector3(0.5, 0.2, 0),
					new BABYLON.Vector3(0.4, 0.2, 0),
					new BABYLON.Vector3(0.4, 0.05, 0),
					new BABYLON.Vector3(0.05, 0.1, 0),
					new BABYLON.Vector3(0.05, 0.8, 0),
					new BABYLON.Vector3(0.15, 0.9, 0)
				]

				// 创建车床喷泉
				const fountain = BABYLON.MeshBuilder.CreateLathe('fountain', {
					shape: fountainProfile,
					sideOrientation: BABYLON.Mesh.DOUBLESIDE
				})
				fountain.position.x = -4
				fountain.position.z = -6

				// 天空盒
				const skybox = BABYLON.MeshBuilder.CreateBox('skyBox', {
					size: 150
				}, scene)
				const skyboxMaterial = new BABYLON.StandardMaterial('skyBox', scene)
				skyboxMaterial.backFaceCulling = false
				skyboxMaterial.reflectionTexture = new BABYLON.CubeTexture('./babylon/textures/skybox', scene)
				skyboxMaterial.reflectionTexture.coordinatesMode = BABYLON.Texture.SKYBOX_MODE
				skyboxMaterial.diffuseColor = new BABYLON.Color3(0, 0, 0)
				skyboxMaterial.specularColor = new BABYLON.Color3(0, 0, 0)
				skybox.material = skyboxMaterial
				BABYLON.SceneLoader.ImportMeshAsync('', './babylon/scenes/', 'valleyvillage.glb')







				return scene
			}
		</script>
	</body>

</html>